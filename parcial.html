<!DOCTYPE html>
<html lang="es-MX">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Parcial — Blue Origin Replica</title>

<link rel="icon" href="assets/img/logo.png" type="image/png" />
<link rel="preconnect" href="https://d1o72l87sylvqg.cloudfront.net" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
  :root{
    --blue:#0033DD; --white:#fff;
    --indigo:#7c3aed; --teal:#06b6d4;
    --ink:#e5e7eb; --muted:#2a2a2a;
    --soft:#0d0d0d; --card:#111111;
    /* Footer negro */
    --foot-left:#0b0b0b; --foot-right:#0b0b0b; --line:#1e1e1e;
  }

  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif}

  a,button,.cta,.burger,.translate-button,.icons a,.oc-close,.oc-link,.oc-overlay,.btn,.btn-mini,.submit{cursor:pointer}
  input,textarea,select{cursor:text}
  .wrap{max-width:1180px;margin:0 auto;padding:0 22px}
  .visuallyHidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

  /* ===== HEADER (igual a index.html) ===== */
  .topbar{position:sticky;top:0;z-index:1000;background:var(--blue);height:96px;display:flex;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.25)}
  .nav{width:100%;padding:0 30px;height:96px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;column-gap:24px}
  .brand img{height:52px;width:auto;display:block}
  .nav-center{justify-self:center;display:flex;gap:54px;text-transform:uppercase;letter-spacing:.2em;font-weight:800;font-size:13px}
  .nav-center a{color:#fff;text-decoration:none}
  .nav-center a:hover{color:#f5f5f5}

  /* Acciones a la derecha: traductor + login-slot + burger */
  .nav-actions{justify-self:end;display:flex;gap:18px;align-items:center}
  .translate-button{background:#0033DD;border:1px solid rgba(255,255,255,.35);border-radius:8px;padding:8px 12px;color:#fff;display:flex;align-items:center;gap:12px}
  .translate-button svg{width:24px;height:24px;fill:#fff}
  #login-slot .cta{display:inline-flex;align-items:center;justify-content:center;height:42px;padding:0 18px;border-radius:8px;background:#fff;color:#0033dd;font-weight:900;letter-spacing:.2em;text-transform:uppercase;font-size:12px;border:1px solid rgba(0,0,0,.06);text-decoration:none}
  .burger{width:42px;height:42px;background:transparent;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:6px;border:none}
  .burger i,.burger::before{content:"";display:block;width:35px;height:5px;background:#fff;border-radius:2px}
  .burger::after{display:none}
  @media (max-width:900px){.nav-center{display:none}}

  /* ===== HERO ===== */
  .hero{height:526px;position:relative;display:flex;align-items:flex-end;overflow:hidden;background:#000}
  .hero::before{content:"";position:absolute;inset:0;background:url("https://midu.dev/courses/python-desde-cero.webp") center/cover no-repeat;filter:brightness(.35)}
  .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(0deg,rgba(0,0,0,.9)0%,rgba(0,0,0,.65)50%,rgba(0,0,0,.4)100%)}
  .hero-inner{position:relative;z-index:1;width:100%;max-width:1200px;padding:80px 22px;color:#fff}
  .kicker{font-size:12px;letter-spacing:.22em;text-transform:uppercase;font-weight:800;color:rgba(255,255,255,.8);margin-bottom:8px}
  h1{margin:0;text-transform:uppercase;font-weight:800;font-size:clamp(34px,5vw,60px)}
  .ns{display:block;font-weight:900;letter-spacing:.06em;font-size:clamp(40px,8vw,80px);margin:.1em 0 .6em}
  .btn{color:#fff;text-decoration:none;border:2px solid rgba(255,255,255,.85);padding:12px 16px;border-radius:8px;font-weight:800;letter-spacing:.2em;text-transform:uppercase;display:inline-block}
  .btn:hover{background:#fff;color:#0033dd}

  /* ===== OFF-CANVAS ===== */
  .oc-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:saturate(130%) blur(2px);opacity:0;pointer-events:none;transition:opacity .25s ease;z-index:1200;}
  .oc-panel{position:fixed;top:0;right:0;height:100%;width:min(420px,88vw);background:#2e2e2e;color:#fff;transform:translateX(100%);transition:transform .28s ease;z-index:1300;display:flex;flex-direction:column;box-shadow:-8px 0 22px rgba(0,0,0,.45);}
  .oc-header{display:flex;align-items:center;justify-content:space-between;padding:22px 20px;border-bottom:1px solid rgba(255,255,255,.12);}
  .oc-feather{height:28px}
  .oc-close{width:40px;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,.4);background:transparent;color:#fff;font-size:18px;display:inline-flex;align-items:center;justify-content:center;}
  .oc-content{padding:10px 20px 24px;overflow:auto}
  .oc-link{display:block;padding:12px 2px;color:#fff;text-decoration:none;text-transform:uppercase;letter-spacing:.16em;font-weight:800;border-bottom:1px solid rgba(255,255,255,.08);}
  .oc-link:hover{background:#3a3a3a}
  .oc-footer{margin-top:auto;padding:14px 20px;border-top:1px solid rgba(255,255,255,.12);display:flex;gap:10px;flex-wrap:wrap}
  .oc-footer a{color:#fff;text-decoration:none;font-size:13px;opacity:.9}
  .oc-footer a:hover{opacity:1;text-decoration:underline}
  .oc-open .oc-overlay{opacity:1;pointer-events:auto}
  .oc-open .oc-panel{transform:translateX(0)}

  /* ===== SECCIÓN PARCIAL ===== */
  .exam{background:#000;color:#fff;padding:44px 0 70px}
  .exam-title{font-size:clamp(28px,4vw,40px);font-weight:900;text-align:center;letter-spacing:.12em;text-transform:uppercase;margin-bottom:26px}
  .exam-title::after{content:"";display:block;width:120px;height:6px;border-radius:999px;background:linear-gradient(90deg,#00e5ff,#7c3aed);margin:10px auto 0}
  .exam-card{background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:22px;margin:0 auto 26px;color:#fff}
  .exam-card h3{font-size:22px;font-weight:800;margin-bottom:14px}
  .exam-card hr{border:0;height:1px;background:var(--muted);margin: 8px 0 18px}
  .exam-widget{display:grid;gap:12px;align-items:end;grid-template-columns:1fr 1fr 1fr auto}
  .btn-mini{height:40px;padding:0 16px;border:0;border-radius:10px;color:#fff;font-weight:800}
  .input{width:min(740px,100%);height:46px;background:transparent;border:2px solid #fff;border-radius:6px;color:#fff;padding:0 10px;font-size:15px}
  select.input{height:46px}

  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px}
  .card{background:var(--card);border:1px solid var(--muted);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:12px}
  .card h4{margin:4px 0 6px;font-size:14px;font-weight:900;letter-spacing:.04em;text-transform:uppercase}
  .thumb{display:grid;place-items:center;height:210px;background:#0b0b0b;border:1px dashed #333;border-radius:12px;overflow:hidden}
  .thumb img{max-width:100%;max-height:100%;object-fit:cover}
  .thumb .pdf{font-size:60px;color:#a78bfa;opacity:.95}
  .thumb iframe.pdf-viewer{width:100%;height:100%;border:0;border-radius:10px;background:#0f1117}
  .actions{display:flex;flex-direction:column;gap:10px;margin-top:auto}
  .btn-ghost,.btn-solid{height:48px;border-radius:10px;font-weight:800;letter-spacing:.02em;display:inline-flex;align-items:center;justify-content:center;gap:10px;text-decoration:none}
  .btn-ghost{border:2px solid rgba(255,255,255,.12);background:#1a1f27;color:#e8eaf0}
  .btn-ghost:hover{border-color:rgba(255,255,255,.22)}
  .btn-solid{border:0;background:var(--blue);color:#fff}
  .btn-solid:hover{filter:brightness(1.06)}

  /* ===== SOCIAL BAR ===== */
  .social-bar{background:var(--blue);padding:18px 20px;display:flex;justify-content:center;align-items:center;gap:22px}
  .social-bar span{font-size:13px;letter-spacing:.2em;text-transform:uppercase;font-weight:800}
  .icons{display:flex;gap:18px;align-items:center}
  .icons a{width:34px;height:34px;border:2px solid #fff;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:18px;text-decoration:none}

  /* ===== FOOTER ===== */
  footer{display:grid;grid-template-columns:45% 22% 33%;min-height:480px;background:linear-gradient(90deg,var(--foot-left) 0 67.6%,var(--foot-right) 67.6% 100%);color:#fff;border-top:1px solid #121212}
  .foot-left{padding:80px 40px 40px 120px;display:flex;flex-direction:column;justify-content:center}
  .feather{width:340px;max-width:90%;margin:0 0 28px 0;filter:brightness(1.05)}
  .legal{margin-top:8px;font-size:14px;color:#d9d9d9}
  .legal-links{margin-top:18px;display:flex;gap:24px}
  .legal-links a{color:#fff;text-decoration:none;border-bottom:1px solid rgba(255,255,255,.35);padding-bottom:3px;font-size:14px}
  .legal-links a:hover{border-bottom-color:#fff}
  .foot-center{position:relative;padding:60px 40px 60px 0}
  .foot-center::before{content:"";position:absolute;left:0;top:38px;bottom:38px;width:1px;background:var(--line)}
  .menu{padding-left:40px;display:flex;flex-direction:column;gap:26px}
  .menu a{color:#fff;text-decoration:none;font-size:16px;letter-spacing:.04em}
  .menu a:hover{text-decoration:underline}
  .select-wrap{margin-top:6px;width:330px;position:relative}
  .select{width:100%;appearance:none;background:transparent;color:#fff;border:2px solid #fff;border-radius:8px;padding:12px 42px 12px 16px;font-size:14px}
  .select-wrap::after{content:"▾";position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:16px;color:#fff}
  .foot-right{background:transparent;padding:60px 56px;display:flex;flex-direction:column;gap:14px}
  .foot-right h3{font-size:22px;font-weight:800;margin-bottom:6px}
  .foot-right p{color:#e1e1e1;font-size:15px;line-height:1.6}
  .req{color:#ccc;font-size:13px;margin:2px 0 6px}
  .label{font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;margin:10px 0 6px}
  .check{display:flex;align-items:flex-start;gap:12px;margin-top:12px}
  .box{width:18px;height:18px;border:2px solid #fff;background:transparent;display:inline-block;flex-shrink:0}
  .check p{color:#e1e1e1;font-size:14px;line-height:1.6}
  .submit{align-self:flex-start;margin-top:14px;background:transparent;color:#fff;border:2px solid #fff;border-radius:4px;padding:8px 14px;text-transform:uppercase;letter-spacing:.12em;font-weight:800;font-size:13px}
  .submit:hover{background:#fff;color:#000}

  @media(max-width:1100px){
    footer{grid-template-columns:1fr}
    .foot-center::before{display:none}
    .menu{padding-left:0}
    .foot-left,.foot-center,.foot-right{padding:28px 22px}
    .feather{width:220px}
  }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="topbar">
  <nav class="nav">
    <a class="brand" href="index.html">
      <img src="https://upla.edu.pe/web/wp-content/uploads/2025/06/upla-white.png" alt="BLUE ORIGIN">
    </a>

    <div class="nav-center">
      <a href="index.html">Inicio</a>
      <a href="perfil.html">Perfil</a>
      <a href="parcial.html">Parcial</a>
      <a href="portafolio.html">Portafolio</a>
      <a href="contacto.html">Contacto</a>
    </div>

    <div class="nav-actions">
      <button type="button" class="translate-button" aria-label="Traducir">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" role="img" aria-labelledby="translateIcon">
          <title id="translateIcon">Translate</title>
          <path d="M3 5h4m0 0h4M7 5V3m-4 9c5.4-1.5 6.6-7 6.6-7m-4 3c1 1.5 2.7 3.2 5.4 4m-8 3v2c0 1.1.9 2 2 2h4m0 0-3-2v4l3-2M21 9V7a2 2 0 0 0-2-2h-4m0 0 3 2V3l-3 2m6 16-4-9-4 9m.9-2H20" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </button>

      <!-- usermenu.js reemplaza SOLO este slot si hay sesión -->
      <span id="login-slot">
        <a class="cta" href="login.html">Iniciar sesión</a>
      </span>

      <button class="burger" id="oc-trigger" aria-haspopup="dialog" aria-controls="offcanvas" aria-expanded="false">
        <span class="visuallyHidden">Main menu</span><i></i>
      </button>
    </div>
  </nav>
</header>

<!-- ===== HERO ===== -->
<main class="hero" aria-label="Parcial">
  <div class="hero-inner">
    <div class="kicker">Evaluación</div>
    <h1>Parcial</h1>
    <strong class="ns">Examen en Línea</strong>
    <p>Aquí podrás consultar información sobre tu examen parcial, instrucciones o resultados.</p>
    <a class="btn" href="index.html">Volver al Inicio</a>
  </div>
</main>

<!-- ===== SECCIÓN PARCIAL ===== -->
<section class="exam" aria-label="Secciones de Parcial">
  <div class="wrap">
    <h2 class="exam-title">PARCIAL</h2>

    <!-- Listado público -->
    <article class="exam-card">
      <h3>Archivos subidos — Sección 1</h3>
      <hr>
      <div id="pub-1" class="cards"></div>
    </article>

    <article class="exam-card">
      <h3>Archivos subidos — Sección 2</h3>
      <hr>
      <div id="pub-2" class="cards"></div>
    </article>

    <!-- CRUD SOLO ADMIN -->
    <section id="adminCRUD" class="exam-card" style="display:none;">
      <h3>Panel de Evidencias (solo administrador)</h3>
      <p style="opacity:.9;margin:.4rem 0 1rem">Visible solo para <strong>josuenehemiasretamozo@gmail.com</strong>.</p>

      <form id="crudForm" class="exam-widget">
        <div>
          <label class="label" for="secSel">Sección</label>
          <select id="secSel" class="input" required>
            <option value="1">Sección 1</option>
            <option value="2">Sección 2</option>
          </select>
        </div>
        <div>
          <label class="label" for="fileSel">Archivo</label>
          <input id="fileSel" class="input" type="file" accept="*/*" />
          <small style="display:block;opacity:.8;margin-top:6px">Máx. recomendado 5 MB</small>
        </div>
        <div>
          <label class="label" for="titleInp">Título (opcional)</label>
          <input id="titleInp" class="input" type="text" placeholder="Ej.: Trabajos Sección 1" />
        </div>
        <div style="display:flex;gap:10px">
          <button id="btnAdd" type="submit" class="btn-mini" style="background:#2563eb">Agregar</button>
          <button id="btnCancelEdit" type="button" class="btn-mini" style="display:none;background:#6b7280">Cancelar</button>
        </div>
        <input type="hidden" id="editId" />
      </form>

      <hr style="border-color:#2a2a2a;margin:14px 0 10px" />

      <div style="display:grid;gap:18px">
        <div>
          <h3 style="margin-bottom:8px">Sección 1 (admin)</h3>
          <div id="list-1" class="cards" style="gap:14px"></div>
        </div>
        <div>
          <h3 style="margin-bottom:8px">Sección 2 (admin)</h3>
          <div id="list-2" class="cards" style="gap:14px"></div>
        </div>
      </div>
    </section>
  </div>
</section>

<!-- SOCIAL BAR -->
<div class="social-bar">
  <span>SÍGUENOS EN NUESTRAS REDES</span>
  <div class="icons">
    <a href="#" aria-label="Twitter"><i class="fa-brands fa-twitter"></i></a>
    <a href="#" aria-label="Facebook"><i class="fa-brands fa-facebook-f"></i></a>
    <a href="#" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
    <a href="#" aria-label="YouTube"><i class="fa-brands fa-youtube"></i></a>
    <a href="#" aria-label="LinkedIn"><i class="fa-brands fa-linkedin-in"></i></a>
  </div>
</div>

<!-- OFF-CANVAS -->
<div class="oc-overlay" id="oc-overlay" hidden></div>
<aside class="oc-panel" id="offcanvas" role="dialog" aria-modal="true" aria-labelledby="oc-title" aria-hidden="true" tabindex="-1">
  <div class="oc-header">
    <img class="oc-feather" src="https://d1o72l87sylvqg.cloudfront.net/blue-origin/logo-feather-optimized.svg" alt="">
    <button class="oc-close" id="oc-close" aria-label="Cerrar menú"><span aria-hidden="true">✕</span></button>
  </div>
  <div class="oc-content">
    <h2 id="oc-title" class="visuallyHidden">Menú principal</h2>
    <a class="oc-link" href="index.html">Inicio</a>
    <a class="oc-link" href="perfil.html">Perfil</a>
    <a class="oc-link" href="parcial.html">Parcial</a>
    <a class="oc-link" href="portafolio.html">Portafolio</a>
    <a class="oc-link" href="contacto.html">Contacto</a>
    <a class="oc-link" href="login.html">Iniciar Sesion</a>
  </div>
  <div class="oc-footer">
    <a href="#">Política de Privacidad</a>
    <a href="#">Términos de Uso</a>
    <a href="#">Accesibilidad</a>
  </div>
</aside>

<!-- FOOTER -->
<footer>
  <section class="foot-left">
    <img class="feather" src="https://d1o72l87sylvqg.cloudfront.net/blue-origin/logo-feather-optimized.svg" alt="Blue Origin Feather">
    <div class="legal">© 2025 BLUE ORIGIN</div>
    <div class="legal-links">
      <a href="#">Política de Privacidad</a>
      <a href="#">Términos de Uso</a>
    </div>
  </section>

  <section class="foot-center">
    <nav class="menu">
      ENLACES RÁPIDOS
      <a href="index.html">Inicio</a>
      <a href="perfil.html">Perfil</a>
      <a href="parcial.html">Parcial</a>
      <a href="portafolio.html">Portafolio</a>
      <a href="contacto.html">Contacto</a>
      <a class="oc-link" href="login.html">Iniciar Sesion</a>
      <div class="select-wrap">
        <select class="select">
          <option selected>Sin preferencia (predeterminado)</option>
          <option>Sans Serif</option>
          <option>Serif</option>
          <option>High Contrast</option>
        </select>
      </div>
    </nav>
  </section>

  <section class="foot-right">
    <h3>Suscribirse</h3>
    <p>Regístrate para recibir actualizaciones sobre los anuncios, lanzamientos y oportunidades de Trabajos.</p>
    <div class="req">* indica un campo requerido</div>
    <label class="label" for="email">Correo electrónico *</label>
    <input class="input" id="email" type="email" required>
    <div class="check">
      <span class="box"></span>
      <p>Por favor, haga clic para confirmar su consentimiento para recibir actualizaciones por correo electrónico de nuestra parte. Nota: tiene el derecho de retirar su consentimiento en cualquier momento contactándonos a josuenehemiasatucusi@gmail.com o haciendo clic en el enlace de "cancelar suscripción" en los correos que le enviamos. Revise nuestra <u>política de privacidad</u> para más información.</p>
    </div>
    <button class="submit" type="button">Enviar</button>
  </section>
</footer>

<!-- ===== Visor PDF modal ===== -->
<div class="viewer-overlay" id="viewer" style="position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:1400">
  <div class="viewer-dialog" role="dialog" aria-labelledby="viewer-title" aria-modal="true" style="width:min(95vw,1400px);height:min(95vh,1000px);background:#111;border:1px solid rgba(255,255,255,.15);border-radius:14px;box-shadow:0 12px 38px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden">
    <header class="viewer-head" style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.1)">
      <div id="viewer-title" style="font-weight:800;letter-spacing:.04em">Vista Previa</div>
      <div class="viewer-actions" style="display:flex;gap:8px">
        <a id="viewer-open" target="_blank" rel="noopener" style="height:36px;padding:0 12px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#1a1f27;color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:8px;font-size:14px"><i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir en pestaña</a>
        <a id="viewer-download" download style="height:36px;padding:0 12px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#1a1f27;color:#fff;text-decoration:none;display:inline-flex;align-items:center;gap:8px;font-size:14px"><i class="fa-solid fa-download"></i> Descargar</a>
        <button id="viewer-close" aria-label="Cerrar" style="height:36px;padding:0 12px;border-radius:8px;border:1px solid rgba(255,255,255,.2);background:#1a1f27;color:#fff;display:inline-flex;align-items:center;gap:8px;font-size:14px"><i class="fa-solid fa-xmark"></i> Cerrar</button>
      </div>
    </header>
    <div id="viewer-body" style="flex:1;position:relative;background:#0f1117"></div>
  </div>
</div>

<!-- ===== JS ===== -->
<script>
  /* Off-canvas */
  const body=document.body, trigger=document.getElementById('oc-trigger'), overlay=document.getElementById('oc-overlay'), panel=document.getElementById('offcanvas'), btnClose=document.getElementById('oc-close');
  function closeOC(){ body.classList.remove('oc-open'); body.style.overflow=''; trigger?.setAttribute('aria-expanded','false'); panel.setAttribute('aria-hidden','true'); overlay.hidden=true; trigger?.focus(); }
  trigger?.addEventListener('click', ()=>{ body.classList.add('oc-open'); body.style.overflow='hidden'; overlay.hidden=false; panel.removeAttribute('aria-hidden'); trigger.setAttribute('aria-expanded','true'); btnClose?.focus(); });
  btnClose?.addEventListener('click', closeOC); overlay?.addEventListener('click', closeOC);

  /* Visor modal (PDF.js) */
  const viewer = document.getElementById('viewer');
  const viewerBody = document.getElementById('viewer-body');
  const viewerTitle = document.getElementById('viewer-title');
  const viewerOpen = document.getElementById('viewer-open');
  const viewerDownload = document.getElementById('viewer-download');
  const viewerClose = document.getElementById('viewer-close');

  const PDFJS_VIEWER = "https://mozilla.github.io/pdf.js/web/viewer.html";
  const absUrl = (href)=> new URL(href, window.location.href).toString();
  const pdfjsUrl = (fileAbs)=> `${PDFJS_VIEWER}?file=${encodeURIComponent(fileAbs)}#pagemode=thumbs&zoom=100`;

  function openViewer(url, title='Vista Previa'){
    const abs = absUrl(url);
    const pdfjs = pdfjsUrl(abs);
    viewerBody.innerHTML='';
    viewerTitle.textContent = title || 'Vista Previa';
    viewerOpen.href = pdfjs;
    viewerDownload.href = abs;
    const iframe = document.createElement('iframe');
    iframe.src = abs.toLowerCase().endsWith('.pdf') ? pdfjs : abs;
    iframe.style.position='absolute'; iframe.style.inset='0'; iframe.style.border='0'; iframe.style.width='100%'; iframe.style.height='100%';
    iframe.title = 'Visor';
    viewerBody.appendChild(iframe);
    viewer.style.display='flex';
    document.body.style.overflow='hidden';
  }
  function closeViewer(){ viewer.style.display='none'; document.body.style.overflow=''; viewerBody.innerHTML=''; }
  viewerClose.addEventListener('click', closeViewer);
  viewer.addEventListener('click', (e)=>{ if(e.target===viewer) closeViewer(); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && viewer.style.display==='flex') closeViewer(); });

  document.addEventListener('click',(e)=>{
    const a = e.target.closest('a.btn-view');
    if(!a) return;
    e.preventDefault();
    const url = a.getAttribute('href');
    const title = a.getAttribute('data-title') || a.closest('.card')?.querySelector('h4')?.textContent || 'Vista Previa';
    openViewer(url, title);
  });
</script>

<!-- Tu UI general + login header dinámico -->
<script src="script.js"></script>
<script type="module" src="usermenu.js"></script>
<script src="offcanvas.js" defer></script>

<!-- ===== FIREBASE + CRUD (Firestore sin Storage) ===== -->
<script type="module">
import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, getDocs, doc,
  query, where, orderBy, updateDoc, deleteDoc, serverTimestamp, limit
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* Config sin Storage */
const cfg = {
  apiKey:"AIzaSyCo3llrVhgJroj1NcM4tGiKOJQVwRIx4FU",
  authDomain:"login-form-6f237.firebaseapp.com",
  projectId:"login-form-6f237",
  appId:"1:711287319130:web:92eec814baf16a665d8663"
};
const app = getApps().length ? getApp() : initializeApp(cfg);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "josuenehemiasretamozo@gmail.com";
const COL = "parcialUploads";
const MAX_BYTES = 5 * 1024 * 1024;

/* DOM */
const adminBox = document.getElementById('adminCRUD');
const form = document.getElementById('crudForm');
const secSel = document.getElementById('secSel');
const fileSel = document.getElementById('fileSel');
const titleInp = document.getElementById('titleInp');
const btnCancel = document.getElementById('btnCancelEdit');
const editIdInp = document.getElementById('editId');
const list1 = document.getElementById('list-1');
const list2 = document.getElementById('list-2');
const pub1 = document.getElementById('pub-1');
const pub2 = document.getElementById('pub-2');

/* Helpers */
const toast=(m)=>{const d=document.createElement('div');d.textContent=m;d.style.cssText="position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;border:1px solid rgba(255,255,255,.2);color:#fff;padding:10px 14px;border-radius:10px;z-index:3000";document.body.appendChild(d);setTimeout(()=>d.remove(),3200)};
const err=(e,ctx)=>{console.error("ERROR",ctx,e?.code||e?.name,e?.message||e);toast("⚠️ "+(e?.code||e?.name||"error")+" "+(e?.message||""))};
const cardTpl=(it,admin=false)=>{const url=it.fileData||"";const isPdf=(it.contentType||"").includes("pdf");return `
  <article class="card" data-id="${it.id}">
    <h4>${it.title||it.filename||"Sin título"}</h4>
    <div class="thumb">${
      isPdf?`<i class="fa-solid fa-file-pdf pdf"></i>`:
      (url?`<img src="${url}" alt="${it.filename||''}">`:`<i class="fa-regular fa-image" style="font-size:60px;opacity:.6"></i>`)
    }</div>
    <div class="actions">
      <a class="btn-ghost btn-view" ${url?`href="${url}"`:""} data-title="${it.title||it.filename||'Archivo'}"><i class="fa-solid fa-up-right-from-square"></i> Ver archivo</a>
      ${url?`<a class="btn-solid" href="${url}" download="${(it.filename||'archivo').replaceAll(' ','_')}"><i class="fa-solid fa-download"></i> Descargar</a>`:""}
      ${admin?`<div style="display:flex;gap:8px"><button class="btn-ghost" data-act="edit">Editar</button><button class="btn-solid" data-act="del">Eliminar</button></div>`:""}
    </div>
  </article>`};

/* Lectura pública */
async function listBySection(sec){
  try{
    const qy = query(collection(db,COL), where("section","==",String(sec)), orderBy("createdAt","desc"));
    const snap = await getDocs(qy);
    return snap.docs.map(d=>({id:d.id, ...d.data()}));
  }catch(_){
    const qy = query(collection(db,COL), where("section","==",String(sec)));
    const snap = await getDocs(qy);
    return snap.docs.map(d=>({id:d.id, ...d.data()}));
  }
}
async function renderSection(sec){
  const target = sec==="1"||sec===1 ? pub1 : pub2;
  const items = await listBySection(sec);
  target.innerHTML = items.length ? items.map(x=>cardTpl(x,false)).join("") : `<div class="card"><h4>Sin archivos</h4></div>`;
  target.querySelectorAll('.card').forEach(card=>{
    const a=card.querySelector('.btn-view'); const t=card.querySelector('.thumb'); if(!a||!t) return;
    const href=a.getAttribute('href')||''; if(href.toLowerCase().endsWith('.pdf')){ t.innerHTML=''; const iframe=document.createElement('iframe'); iframe.src = "https://mozilla.github.io/pdf.js/web/viewer.html?file="+encodeURIComponent(href)+"#pagemode=thumbs&zoom=100"; iframe.className='pdf-viewer'; iframe.title='Vista previa PDF'; t.appendChild(iframe); }
  });
}
async function renderPublic(){ await Promise.all([renderSection(1),renderSection(2)]); }

/* Admin render */
async function renderAdmin(){
  const [s1,s2] = await Promise.all([listBySection(1),listBySection(2)]);
  list1.innerHTML = s1.length ? s1.map(x=>cardTpl(x,true)).join("") : `<div class="card"><h4>Sin archivos</h4></div>`;
  list2.innerHTML = s2.length ? s2.map(x=>cardTpl(x,true)).join("") : `<div class="card"><h4>Sin archivos</h4></div>`;
}
function resetForm(){ editIdInp.value=""; titleInp.value=""; fileSel.value=""; btnCancel.style.display="none"; form.querySelector("#btnAdd").textContent="Agregar" }

/* Archivo -> base64 */
const fileToDataURL = (file)=> new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file); });

/* Crear / Actualizar */
form?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const section = secSel.value;
  const file = fileSel.files[0] || null;
  const title = titleInp.value.trim();

  if(!section){ toast("Selecciona una sección."); return; }

  try{
    if(editIdInp.value){
      const id = editIdInp.value;
      let payload = { section };
      if(title) payload.title = title;
      if(file){
        if(file.size > MAX_BYTES){ toast("Archivo muy grande. Máx. 5 MB."); return; }
        const dataURL = await fileToDataURL(file);
        payload = { ...payload, filename:file.name, contentType:file.type||"application/octet-stream", size:file.size, fileData:dataURL };
      }
      await updateDoc(doc(db,COL,id), payload);
      toast("Actualizado ✅"); resetForm();
      await renderPublic(); await renderAdmin(); return;
    }

    if(!file){ toast("Selecciona un archivo."); return; }
    if(file.size > MAX_BYTES){ toast("Archivo muy grande. Máx. 5 MB."); return; }

    const dataURL = await fileToDataURL(file);
    await addDoc(collection(db,COL), {
      section,
      filename: file.name,
      title: title || file.name,
      contentType: file.type || "application/octet-stream",
      size: file.size,
      fileData: dataURL,
      createdAt: serverTimestamp()
    });

    toast("Guardado en Firestore ✅"); resetForm();
    await renderPublic(); await renderAdmin();

  }catch(eAll){ err(eAll,"submit") }
});
btnCancel?.addEventListener("click", resetForm);

/* Delegación eventos (admin) */
function hookList(container){
  container?.addEventListener("click", async (ev)=>{
    const btn=ev.target.closest("button"); if(!btn) return;
    const card=ev.target.closest(".card"); const id=card?.dataset?.id; const act=btn?.dataset?.act; if(!id||!act) return;

    if(act==="edit"){
      const sec = container===list1 ? "1" : "2";
      secSel.value = sec;
      titleInp.value = card.querySelector("h4")?.textContent?.trim()||"";
      editIdInp.value = id;
      form.querySelector("#btnAdd").textContent="Actualizar"; btnCancel.style.display="inline-flex"; toast("Modo edición");
    }

    if(act==="del"){
      if(!confirm("¿Eliminar este archivo definitivamente?")) return;
      try{
        await deleteDoc(doc(db,COL,id));
        toast("Eliminado 🗑️");
        await renderPublic(); await renderAdmin();
      }catch(eDel){ err(eDel,"delete") }
    }
  });
}
hookList(list1); hookList(list2);

/* Gate + render inicial */
onAuthStateChanged(auth, async (user)=>{
  const isAdmin = !!user && (user.email===ADMIN_EMAIL);
  adminBox.style.display = isAdmin ? "block" : "none";
  await renderPublic();
  if(isAdmin){ await renderAdmin() }
});
</script>
</body>
</html>
